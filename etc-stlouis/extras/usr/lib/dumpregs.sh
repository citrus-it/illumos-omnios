#!/bin/ksh

#
# Print the current value of various IOHC, PCIe core and PCIe registers.
# This relies on the `usmn` driver being loaded, and `/usr/lib/usmn` being
# present.
#

typeset -r DEV=$1

function fatal {
	echo "$*" >&2
	exit 1
}

usmndev=/devices/pseudo/amdzen@0/usmn@2:usmn.0
usmn=/usr/lib/usmn

[ -c "$usmndev" ] || fatal "Didn't find chardev $usmndev"
[ -x "$usmn" ] || fatal "Didn't find executable $usmn"

typeset -A gimlet_map=(
	[N0]=( nbio=0 coreno=0 portno=0)
	[N1]=( nbio=0 coreno=0 portno=1)
	[N2]=( nbio=0 coreno=0 portno=2)
	[N3]=( nbio=0 coreno=0 portno=3)
	[N4]=( nbio=3 coreno=1 portno=3)
	[N5]=( nbio=3 coreno=1 portno=2)
	[N6]=( nbio=3 coreno=1 portno=1)
	[N7]=( nbio=2 coreno=0 portno=2)
	[N8]=( nbio=2 coreno=0 portno=1)
	[N9]=( nbio=2 coreno=0 portno=0)
	[T6]=( nbio=1 coreno=0 portno=0)
	[M2A]=(nbio=3 coreno=0 portno=2)
	[M2B]=(nbio=2 coreno=1 portno=2)
	[RSW]=(nbio=0 coreno=1 portno=1)
)

typeset -A systems=(
	[Oxide,Gimlet]=gimlet_map
)

typeset -r system=`prtconf /devices`

[ -n "${systems[$system]}" ] || fatal "Unhandled system '$system'"

nameref sysdata=${systems[$system]}

if [ -z "${sysdata[$DEV]}" ]; then
	{
		print "Usage: $0 <device>"
		print "  Available devices: ${!sysdata[@]}"
	} >&2
	exit 1
fi

typeset -ri nbio=${sysdata[$DEV].nbio}
typeset -ri coreno=${sysdata[$DEV].coreno}
typeset -ri portno=${sysdata[$DEV].portno}

corebase=0x11180000
portbase=0x11140000
iohcbase=0x13b31000

(( coreaddr = corebase + (nbio<<20 | coreno<<22) ))
(( portaddr = portbase + (nbio<<20 | coreno<<22 | portno<<12) ))
(( iohcaddr = iohcbase + (nbio<<20 | coreno<<13 | portno<<10) ))

function dump_one {
	typeset base=$1

	while read name off; do
		off="0x$off"
		((reg = base + off))
		regx=`printf "0x%x" $reg`
		val=`$usmn -d $usmndev $regx | awk '{print $2}'`
		regx=`echo $regx | sed 's/....$/_&/'`
		printf "%50s (%s) = %s\n" $name $regx $val
	done
}

function dump {
	coreregs | dump_one $coreaddr
	portregs | dump_one $portaddr
	iohcregs | dump_one $iohcaddr
}

function coreregs {
	cat << EOM
PCIECORE::PCIE_HW_DEBUG				8
PCIECORE::PCIE_HW_DEBUG_LC			c
PCIECORE::PCIE_RX_NUM_NAK			38
PCIECORE::PCIE_RX_NUM_NAK_GENERATED		3c
PCIECORE::PCIE_CNTL				40
PCIECORE::PCIE_CONFIG_CNTL			44
PCIECORE::PCIE_DEBUG_CNTL			48
PCIECORE::PCIE_CNTL2				70
PCIECORE::PCIE_RX_CNTL2				74
PCIECORE::PCIE_TX_F0_ATTR_CNTL			78
PCIECORE::PCIE_CI_CNTL				80
PCIECORE::PCIE_BUS_CNTL				84
PCIECORE::PCIE_LC_STATE6			88
PCIECORE::PCIE_LC_STATE7			8c
PCIECORE::PCIE_LC_STATE8			90
PCIECORE::PCIE_LC_STATE9			94
PCIECORE::PCIE_LC_STATE10			98
PCIECORE::PCIE_LC_STATE11			9c
PCIECORE::PCIE_LC_STATUS1			a0
PCIECORE::PCIE_LC_STATUS2			a4
PCIECORE::PCIE_TX_CNTL3				a8
PCIECORE::PCIE_TX_STATUS			ac
PCIECORE::PCIE_WPR_CNTL				c0
PCIECORE::PCIE_RX_LAST_TLP0			c4
PCIECORE::PCIE_RX_LAST_TLP1			c8
PCIECORE::PCIE_RX_LAST_TLP2			cc
PCIECORE::PCIE_RX_LAST_TLP3			d0
PCIECORE::PCIE_TX_LAST_TLP0			d4
PCIECORE::PCIE_TX_LAST_TLP1			d8
PCIECORE::PCIE_TX_LAST_TLP2			dc
PCIECORE::PCIE_TX_LAST_TLP3			e0
PCIECORE::PCIE_I2C_REG_ADDR_EXPAND		e8
PCIECORE::PCIE_I2C_REG_DATA			ec
PCIECORE::PCIE_CFG_CNTL				f0
PCIECORE::PCIE_LC_PM_CNTL			f4
PCIECORE::PCIE_LC_PORT_ORDER_CNTL		f8
PCIECORE::PCIE_P_CNTL				100
PCIECORE::PCIE_P_BUF_STATUS			104
PCIECORE::PCIE_P_DECODER_STATUS			108
PCIECORE::PCIE_P_MISC_STATUS			10c
PCIECORE::PCIE_P_RX_L0S_FTS			140
PCIECORE::PCIE_TX_CCIX_CNTL0			150
PCIECORE::PCIE_TX_CCIX_CNTL1			154
PCIECORE::PCIE_TX_CCIX_PORT_MAP			158
PCIECORE::PCIE_TX_CCIX_ERR_CTL			15c
PCIECORE::PCIE_RX_CCIX_CTL0			160
PCIECORE::PCIE_RX_AD				188
PCIECORE::PCIE_SDP_CTRL				18c
PCIECORE::PCIE_NBIO_CLKREQb_MAP_CNTL		190
PCIECORE::PCIE_SDP_RC_SLV_ATTR_CTRL		198
PCIECORE::PCIE_STRAP_F0				2c0
PCIECORE::PCIE_STRAP_NTB			2c4
PCIECORE::PCIE_STRAP_MISC			300
PCIECORE::PCIE_STRAP_MISC2			304
PCIECORE::PCIE_STRAP_PI				308
PCIECORE::PCIE_PRBS_CLR				320
PCIECORE::PCIE_PRBS_STATUS1			324
PCIECORE::PCIE_PRBS_STATUS2			328
PCIECORE::PCIE_PRBS_FREERUN			32c
PCIECORE::PCIE_PRBS_MISC			330
PCIECORE::PCIE_PRBS_USER_PATTERN		334
PCIECORE::PCIE_PRBS_LO_BITCNT			338
PCIECORE::PCIE_PRBS_HI_BITCNT			33c
PCIECORE::PCIE_PRBS_ERRCNT0			340
PCIECORE::PCIE_PRBS_ERRCNT1			344
PCIECORE::PCIE_PRBS_ERRCNT2			348
PCIECORE::PCIE_PRBS_ERRCNT3			34c
PCIECORE::PCIE_PRBS_ERRCNT4			350
PCIECORE::PCIE_PRBS_ERRCNT5			354
PCIECORE::PCIE_PRBS_ERRCNT6			358
PCIECORE::PCIE_PRBS_ERRCNT7			35c
PCIECORE::PCIE_PRBS_ERRCNT8			360
PCIECORE::PCIE_PRBS_ERRCNT9			364
PCIECORE::PCIE_PRBS_ERRCNT10			368
PCIECORE::PCIE_PRBS_ERRCNT11			36c
PCIECORE::PCIE_PRBS_ERRCNT12			370
PCIECORE::PCIE_PRBS_ERRCNT13			374
PCIECORE::PCIE_PRBS_ERRCNT14			378
PCIECORE::PCIE_PRBS_ERRCNT15			37c
PCIECORE::SWRST_COMMAND_STATUS			400
PCIECORE::SWRST_GENERAL_CONTROL			404
PCIECORE::SWRST_COMMAND_0			408
PCIECORE::SWRST_COMMAND_1			40c
PCIECORE::SWRST_CONTROL_0			410
PCIECORE::SWRST_CONTROL_1			414
PCIECORE::SWRST_CONTROL_2			418
PCIECORE::SWRST_CONTROL_3			41c
PCIECORE::SWRST_CONTROL_4			420
PCIECORE::SWRST_CONTROL_5			424
PCIECORE::SWRST_CONTROL_6			428
PCIECORE::CPM_CONTROL				460
PCIECORE::CPM_SPLIT_CONTROL			464
PCIECORE::SMN_APERTURE_A			474
PCIECORE::SMN_APERTURE_B			478
PCIECORE::RSMU_MASTER_CONTROL			47c
PCIECORE::RSMU_SLAVE_CONTROL			480
PCIECORE::RSMU_POWER_GATING_CONTROL		484
PCIECORE::RSMU_BIOS_TIMER_CMD			488
PCIECORE::RSMU_BIOS_TIMER_CNTL			48c
PCIECORE::RSMU_BIOS_TIMER_DEBUG			490
PCIECORE::LNCNT_CONTROL				494
PCIECORE::LNCNT_QUAN_THRD			49c
PCIECORE::LNCNT_WEIGHT				4a0
PCIECORE::SMU_HP_STATUS_UPDATE			4b0
PCIECORE::HP_SMU_COMMAND_UPDATE			4b4
PCIECORE::SMU_HP_END_OF_INTERRUPT		4b8
PCIECORE::SMU_INT_PIN_SHARING_PORT_INDICATOR	4bc
PCIECORE::PCIE_PGMST_CNTL			4c0
PCIECORE::PCIE_PGSLV_CNTL			4c4
PCIECORE::SMU_PCIE_DF_Address			4c8
PCIECORE::LC_CPM_CONTROL_0			4cc
PCIECORE::LC_CPM_CONTROL_1			4d0
PCIECORE::PCIE_RXMARGIN_CONTROL_CAPABILITIES	4d4
PCIECORE::PCIE_RXMARGIN_1_SETTINGS		4d8
PCIECORE::PCIE_RXMARGIN_2_SETTINGS		4dc
PCIECORE::PCIE_PRESENCE_DETECT_SELECT		4e0
PCIECORE::PCIE_LC_DEBUG_CNTL			4e4
PCIECORE::SMU_PCIE_FENCED1_REG			600
PCIECORE::SMU_PCIE_FENCED2_REG			604
EOM
}

function portregs {
	cat << EOM
PCIEPORT::PCIEP_HW_DEBUG			8
PCIEPORT::PCIEP_HW_DEBUG_LC			c
PCIEPORT::PCIEP_PORT_CNTL			40
PCIEPORT::PCIEP_SDP_CTRL			44
PCIEPORT::PCIE_TX_CNTL				80
PCIEPORT::PCIE_TX_REQUESTER_ID			84
PCIEPORT::PCIE_TX_VENDOR_SPECIFIC		88
PCIEPORT::PCIE_TX_REQUEST_NUM_CNTL		8c
PCIEPORT::PCIE_TX_SEQ				90
PCIEPORT::PCIE_TX_REPLAY			94
PCIEPORT::PCIE_TX_ACK_LATENCY_LIMIT		98
PCIEPORT::PCIE_TX_NOP_DLLP			9c
PCIEPORT::PCIE_TX_CNTL_2			a0
PCIEPORT::PCIE_TX_CREDITS_ADVT_P		c0
PCIEPORT::PCIE_TX_CREDITS_ADVT_NP		c4
PCIEPORT::PCIE_TX_CREDITS_ADVT_CPL		c8
PCIEPORT::PCIE_TX_CREDITS_INIT_P		cc
PCIEPORT::PCIE_TX_CREDITS_INIT_NP		d0
PCIEPORT::PCIE_TX_CREDITS_INIT_CPL		d4
PCIEPORT::PCIE_TX_CREDITS_STATUS		d8
PCIEPORT::PCIE_TX_CREDITS_FCU_THRESHOLD		dc
PCIEPORT::PCIE_TX_CCIX_PORT_CNTL0		e0
PCIEPORT::PCIE_TX_CCIX_PORT_CNTL1		e4
PCIEPORT::PCIE_CCIX_STACKED_BASE		e8
PCIEPORT::PCIE_CCIX_STACKED_LIMIT		ec
PCIEPORT::PCIE_CCIX_DUMMY_RD_UPPER_ADDR		f0
PCIEPORT::PCIE_CCIX_DUMMY_RD_LOWER_ADDR		f4
PCIEPORT::PCIE_CCIX_DUMMY_RD_CTRL		f8
PCIEPORT::PCIE_CCIX_DUMMY_WR_UPPER_ADDR		fc
PCIEPORT::PCIE_CCIX_DUMMY_WR_LOWER_ADDR		100
PCIEPORT::PCIE_CCIX_MISC_STATUS			104
PCIEPORT::PCIE_P_PORT_LANE_STATUS		140
PCIEPORT::PCIE_FC_P				180
PCIEPORT::PCIE_FC_NP				184
PCIEPORT::PCIE_FC_CPL				188
PCIEPORT::PCIE_FC_P_VC1				18c
PCIEPORT::PCIE_FC_NP_VC1			18c
PCIEPORT::PCIE_FC_CPL_VC1			194
PCIEPORT::PCIE_ERR_CNTL				1a8
PCIEPORT::PCIE_RX_CNTL				1c0
PCIEPORT::PCIE_RX_EXPECTED_SEQNUM		1c4
PCIEPORT::PCIE_RX_VENDOR_SPECIFIC		1c8
PCIEPORT::PCIE_RX_CNTL3				1d0
PCIEPORT::PCIE_RX_CREDITS_ALLOCATED_P		200
PCIEPORT::PCIE_RX_CREDITS_ALLOCATED_NP		204
PCIEPORT::PCIE_RX_CREDITS_ALLOCATED_CPL		208
PCIEPORT::PCIEP_ERROR_INJECT_PHYSICAL		20c
PCIEPORT::PCIEP_ERROR_INJECT_TRANSACTION	210
PCIEPORT::PCIEP_NAK_COUNTER			218
PCIEPORT::PCIEP_RX_CAPTURED_LTR_CTRL_STATUS	220
PCIEPORT::PCIEP_RX_CAPTURED_LTR_THRESHOLD_VALUES 224
PCIEPORT::PCIE_LC_CNTL				280
PCIEPORT::PCIE_LC_TRAINING_CNTL			284
PCIEPORT::PCIE_LC_LINK_WIDTH_CNTL		288
PCIEPORT::PCIE_LC_N_FTS_CNTL			28c
PCIEPORT::PCIE_LC_SPEED_CNTL			290
PCIEPORT::PCIE_LC_STATE0			294
PCIEPORT::PCIE_LC_STATE1			298
PCIEPORT::PCIE_LC_STATE2			29c
PCIEPORT::PCIE_LC_STATE3			2a0
PCIEPORT::PCIE_LC_STATE4			2a4
PCIEPORT::PCIE_LC_STATE5			2a8
PCIEPORT::PCIE_LINK_MANAGEMENT_CNTL2		2ac
PCIEPORT::PCIE_LC_CNTL2				2c4
PCIEPORT::PCIE_LC_BW_CHANGE_CNTL		2c8
PCIEPORT::PCIE_LC_CDR_CNTL			2cc
PCIEPORT::PCIE_LC_LANE_CNTL			2d0
PCIEPORT::PCIE_LC_CNTL3				2d4
PCIEPORT::PCIE_LC_CNTL4				2d8
PCIEPORT::PCIE_LC_CNTL5				2dc
PCIEPORT::PCIE_LC_FORCE_COEFF			2e0
PCIEPORT::PCIE_LC_BEST_EQ_SETTINGS		2e4
PCIEPORT::PCIE_LC_FORCE_EQ_REQ_COEFF		2e8
PCIEPORT::PCIE_LC_CNTL6				2ec
PCIEPORT::PCIE_LC_CNTL7				2f0
PCIEPORT::PCIE_LINK_MANAGEMENT_STATUS		2f4
PCIEPORT::PCIE_LINK_MANAGEMENT_MASK		2f8
PCIEPORT::PCIE_LINK_MANAGEMENT_CNTL		2fc
PCIEPORT::PCIEP_STRAP_LC			300
PCIEPORT::PCIEP_STRAP_MISC			304
PCIEPORT::PCIEP_STRAP_LC2			308
PCIEPORT::PCIE_LC_L1_PM_SUBSTATE		318
PCIEPORT::PCIE_LC_L1_PM_SUBSTATE2		31c
PCIEPORT::PCIE_LC_PORT_ORDER			320
PCIEPORT::PCIE_BCH_ECC_CNTL			340
PCIEPORT::PCIEP_HPGI_PRIVATE			348
PCIEPORT::PCIEP_HPGI				368
PCIEPORT::PCIEP_HCNT_DESCRIPTOR			36c
PCIEPORT::PCIE_LC_CNTL8				374
PCIEPORT::PCIE_LC_CNTL9				378
PCIEPORT::PCIE_LC_FORCE_COEFF2			37c
PCIEPORT::PCIE_LC_FORCE_EQ_REQ_COEFF2		380
PCIEPORT::PCIE_LC_FINE_GRAIN_CLK_GATE_OVERRIDES	388
PCIEPORT::PCIE_LC_CNTL10			38c
PCIEPORT::PCIE_LC_CNTL11			390
EOM
}

function iohcregs {
	cat << EOM
IOHC::IOHC_Bridge_CNTL 				4
IOHC::IOHC_Bridge_STATUS			8
EOM
}

dump

