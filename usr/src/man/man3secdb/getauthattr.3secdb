.\" The contents of this file are subject to the terms of the Common
.\" Development and Distribution License (the "License").  You may not use
.\" this file except in compliance with the License.
.\"
.\" You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE or
.\" http://www.opensolaris.org/os/licensing.  See the License for the
.\" specific language governing permissions and limitations under the
.\" License.
.\"
.\" When distributing Covered Code, include this CDDL HEADER in each file
.\" and include the License file at usr/src/OPENSOLARIS.LICENSE.  If
.\" applicable, add the following below this CDDL HEADER, with the fields
.\" enclosed by brackets "[]" replaced with your own identifying
.\" information: Portions Copyright [yyyy] [name of copyright owner]
.\"
.\" Copyright (c) 2009, Sun Microsystems, Inc.  All Rights Reserved.
.\" Copyright 2022 OmniOS Community Edition (OmniOSce) Association.
.\"
.Dd March 6, 2022
.Dt GETAUTHATTR 3SECDB
.Os
.Sh NAME
.Nm getauthattr ,
.Nm getauthnam ,
.Nm free_authattr ,
.Nm setauthattr ,
.Nm endauthattr ,
.Nm chkauthattr ,
.Nm chkauthattr_ucred
.Nd get authorization entry
.Sh LIBRARY
.Lb libsecdb
.Sh SYNOPSIS
.In auth_attr.h
.In secdb.h
.Ft "authattr_t *"
.Fo getauthattr
.Fa void
.Fc
.Ft "authattr_t *"
.Fo getauthnam
.Fa "const char *name"
.Fc
.Ft void
.Fo free_authattr
.Fa "authattr_t *auth"
.Fc
.Ft void
.Fo setauthattr
.Fa void
.Fc
.Ft void
.Fo endauthattr
.Fa void
.Fc
.Ft int
.Fo chkauthattr
.Fa "const char *authname"
.Fa "const char *username"
.Fc
.Ft int
.Fo chkauthattr_ucred
.Fa "const char *authname"
.Fa "const char *username"
.Fa "const ucred_t *cred"
.Fc
.Sh DESCRIPTION
The
.Fn getauthattr
and
.Fn getauthnam
functions each return an
.Xr auth_attr 5
entry.
Entries can come from any of the sources specified in the
.Xr nsswitch.conf 5
file.
.Pp
.Fn getauthattr
enumerates
.Xr auth_attr 5
entries.
.Fn getauthnam
searches for an
.Xr auth_attr 5
entry with a given authorization name,
.Ar name .
Successive calls to these functions return either successive
.Xr auth_attr 5
entries or
.Dv NULL .
.Pp
The internal representation of an
.Xr auth_attr 5
entry is an
.Vt authattr_t
structure defined in
.In auth_attr.h
with the following members:
.Bd -literal -offset 4n
char   *name;	     /* name of the authorization */
char   *res1;	     /* reserved for future use */
char   *res2;	     /* reserved for future use */
char   *short_desc;  /* short description */
char   *long_desc;   /* long description */
kva_t  *attr;	     /* array of key-value pair attributes */
.Ed
.Pp
The
.Fn setauthattr
function
.Dq rewinds
to the beginning of the enumeration of
.Xr auth_attr 5
entries.
Calls to
.Fn getauthnam
can leave the enumeration in an indeterminate state.
Therefore,
.Fn setauthattr
should be called before the first call to
.Fn getauthattr
.Pp
The
.Fn endauthattr
function may be called to indicate that
.Xr auth_attr 5
processing is complete; the system may then close any open
.Xr auth_attr 5
file, deallocate storage, and so forth.
.Pp
The
.Fn chkauthattr
function verifies whether or not a user has a given authorization.
It first reads the
.Sy AUTHS_GRANTED
key in the
.Xr policy.conf 5
file and returns 1 if it finds a match for the given authorization.
If
.Fn chkauthattr
does not find a match and the
.Fa username
is the name of the
.Dq console user ,
defined as the owner of
.Pa /dev/console ,
it first reads the
.Sy CONSOLE_USER
key in
.Xr policy.conf 5
and returns 1 if the given authorization is in any of the profiles
specified in the
.Sy CONSOLE_USER
keyword, then reads the
.Sy PROFS_GRANTED
key in
.Xr policy.conf 5
and returns 1 if the given authorization is in any profiles specified with
the
.Sy PROFS_GRANTED
keyword.
If
.Fa username
matches the owner of the current process, and that process has the
.Dv PRIV_PFEXEC_AUTH
property set, then the
.Sy AUTHPROFS_GRANTED
key in
.Xr policy.conf 5
is also checked.
If a match is not found from the default authorizations and default profiles,
.Fn chkauthattr
reads the
.Xr user_attr 5
database.
If it does not find a match in
.Xr user_attr 5 ,
it reads the
.Xr prof_attr 5
database, using the list of profiles assigned to the user, and checks if any of
the profiles assigned to the user has the given authorization.
If
.Fa username
matches the owner of the current process, and that process has the
.Dv PRIV_PFEXEC_AUTH
property set, then the authenticated profiles assigned to the user are also
checked.
The
.Fn chkauthattr
function returns 0 if it does not find a match in any of the three sources or
if the user does not exist.
.Pp
.Fn chkauthattr_ucred
is a variant of
.Fn chkauthattr
that uses the provided
.Fa ucred
when determining whether the
.Sy AUTHPROFS_GRANTED
key in
.Xr policy.conf 5
and the user's assigned authenticated profiles are checked.
.Pp
A user is considered to have been assigned an authorization if either of the
following are true:
.Bl -bullet -width Ds
.It
The authorization name matches exactly any authorization assigned in the
.Xr user_attr 5
or
.Xr prof_attr 5
databases
.Pq authorization names are case-sensitive .
.It
The authorization name suffix is not the key word
.Sy grant
and the authorization name matches any authorization up to the asterisk
.Pq *
character assigned in the
.Xr user_attr 5
or
.Xr prof_attr 5
databases.
.El
.Pp
The examples in the following table illustrate the conditions under which a
user is assigned an authorization.
.Bl -column solaris.printer.postscript solaris.printer.postscript "authorized?"
.It Ta Sy /etc/security/policy.conf , Ta Sy Is user
.It Sy Authorization name Ta Sy user_attr No or Sy prof_attr No entry \
Ta Sy authorized\&?
.It Sy -------------------------- Ta Sy ---------------------------- \
Ta Sy -----------
.It solaris.printer.postscript Ta solaris.printer.postscript Ta Yes
.It solaris.printer.postscript Ta solaris.printer.* Ta Yes
.It solaris.printer.grant Ta solaris.printer.* Ta "No"
.El
.Pp
The
.Fn free_authattr
function releases memory allocated by the
.Fn getauthnam
and
.Fn getauthattr
functions.
.Sh RETURN VALUES
The
.Fn getauthattr
function returns a pointer to an
.Vt authattr_t
if it successfully enumerates an entry; otherwise it returns
.Dv NULL ,
indicating the end of the enumeration.
.Pp
.Fn getauthnam
returns a pointer to an
.Vt authattr_t
if it successfully locates the requested entry; otherwise it returns
.Dv NULL .
.Pp
.Fn chkauthattr
returns 1 if the user is authorized and 0 if the user does not exist or is not
authorized.
.Sh USAGE
The
.Fn getauthattr
and
.Fn getauthnam
functions both allocate memory for the pointers they return.
This memory should be deallocated with a call to
.Fn free_authattr .
.Pp
Individual attributes in the
.Fa attr
field of
.Vt authattr_t
can be referred to by calling the
.Xr kva_match 3SECDB
function.
.Sh WARNINGS
Because the list of legal keys is likely to expand, code must be written to
ignore unknown key-value pairs without error.
.Sh FILES
.Bl -tag -width Ds
.It Pa /etc/nsswitch.conf
configuration file lookup information for the name service switch
.It Pa /etc/user_attr
extended user attributes
.It Pa /etc/security/auth_attr
authorization attributes
.It Pa /etc/security/policy.conf
policy definitions
.It Pa /etc/security/prof_attr
profile information
.El
.Sh MT-LEVEL
.Sy MT-Safe
.Sh SEE ALSO
.Xr getexecattr 3SECDB ,
.Xr getprofattr 3SECDB ,
.Xr getuserattr 3SECDB ,
.Xr kva_match 3SECDB ,
.Xr auth_attr 5 ,
.Xr nsswitch.conf 5 ,
.Xr policy.conf 5 ,
.Xr prof_attr 5 ,
.Xr user_attr 5 ,
.Xr attributes 7 ,
.Xr rbac 7
