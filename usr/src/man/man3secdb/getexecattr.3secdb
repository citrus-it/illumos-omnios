.\" The contents of this file are subject to the terms of the Common
.\" Development and Distribution License (the "License").  You may not use
.\" this file except in compliance with the License.
.\"
.\" You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE or
.\" http://www.opensolaris.org/os/licensing.  See the License for the
.\" specific language governing permissions and limitations under the
.\" License.
.\"
.\" When distributing Covered Code, include this CDDL HEADER in each file
.\" and include the License file at usr/src/OPENSOLARIS.LICENSE.  If
.\" applicable, add the following below this CDDL HEADER, with the fields
.\" enclosed by brackets "[]" replaced with your own identifying
.\" information: Portions Copyright [yyyy] [name of copyright owner]
.\"
.\" Copyright (c) 2005, Sun Microsystems, Inc.  All Rights Reserved.
.\" Copyright 2018 Peter Tribble
.\" Copyright 2022 OmniOS Community Edition (OmniOSce) Association.
.\"
.Dd March 7, 2022
.Dt GETEXECATTR 3SECDB
.Os
.Sh NAME
.Nm getexecattr ,
.Nm free_execattr ,
.Nm setexecattr ,
.Nm endexecattr ,
.Nm getexecuser ,
.Nm getexecprof ,
.Nm match_execattr
.Nd get execution profile entry
.Sh LIBRARY
.Lb libsecdb
.Sh SYNOPSIS
.In exec_attr.h
.In secdb.h
.Ft "execattr_t *"
.Fo getexecattr
.Fa void
.Fc
.Ft void
.Fo free_execattr
.Fa "execattr_t *ep"
.Fc
.Ft void
.Fo setexecattr
.Fa void
.Fc
.Ft void
.Fo endexecattr
.Fa void
.Fc
.Ft "execattr_t *"
.Fo getexecuser
.Fa "const char *username"
.Fa "const char *type"
.Fa "const char *id"
.Fa "int search_flag"
.Fc
.Ft "execattr_t *"
.Fo getexecprof
.Fa "const char *profname"
.Fa "const char *type"
.Fa "const char *id"
.Fa "int search_flag"
.Fc
.Ft "execattr_t *"
.Fo match_execattr
.Fa "execattr_t *ep"
.Fa "char *profname"
.Fa "char *type"
.Fa "char *id"
.Fc
.Sh DESCRIPTION
The
.Fn getexecattr
function returns a single
.Xr exec_attr 5
entry.
Entries can come from any of the sources specified in the
.Xr nsswitch.conf 5
file.
.Pp
Successive calls to
.Fn getexecattr
return either successive
.Xr exec_attr 5
entries or
.Dv NULL .
Since
.Fn getexecattr
always returns a single entry, the
.Fa next
pointer in the
.Vt execattr_t
data structure points to
.Dv NULL .
.Pp
The internal representation of an
.Xr exec_attr 5
entry is an
.Vt execattr_t
structure defined in
.In exec_attr.h
with the following members:
.Bd -literal -offset 4n
char  *name;      /* name of the profile */
char  *policy;    /* policy under which the attributes are relevant*/
char  *type;      /* type of profile */
char  *res1;      /* reserved for future use */
char  *res2;      /* reserved for future use */
char  *id;        /* unique identifier */
kva_t *attr;      /* attributes */
struct execattr_s *next;  /* optional pointer to next profile */
.Ed
.Pp
The
.Fn free_execattr
function releases memory.
It follows the
.Fa next
pointers in the
.Vt execattr_t
structure so that the entire linked list is released.
.Pp
The
.Fn setexecattr
function
.Dq rewinds
to the beginning of the enumeration of
.Xr exec_attr 5
entries.
Calls to
.Fn getexecuser
can leave the enumeration in an indeterminate state.
Therefore,
.Fn setexecattr
should be called before the first call to
.Fn getexecattr
.Pp
The
.Fn endexecattr
function can be called to indicate that
.Xr exec_attr 5
processing is complete; the library can then close any open files, deallocate
any internal storage, and so forth.
.Pp
The
.Fn getexecuser
function returns a linked list of entries that match the
.Ar type
and
.Ar id
arguments and have a profile that has been assigned to the user specified by
.Ar username ,
as described in
.Xr passwd 5 .
Profiles for the user are obtained from the list of default profiles in
.Xr policy.conf 5
and the
.Xr user_attr 5
database.
Only entries in the name service scope for which the corresponding profile
entry is found in the
.Xr prof_attr 5
database are returned.
.Pp
The
.Fn getexecprof
function returns a linked list of entries that match the
.Ar type
and
.Ar id
arguments and have the profile specified by the
.Ar profname
argument.
Only entries in the name service scope for which the corresponding profile
entry is found in the
.Xr prof_attr 5
database are returned.
.Pp
Using
.Fn getexecuser
and
.Fn getexecprof ,
programmers can search for any
.Ar type
argument, such as the manifest constant
.Dv KV_COMMAND .
The arguments are logically AND-ed together so that only entries exactly
matching all of the arguments are returned.
Wildcard matching applies if there is no exact match for an
.Sy ID .
Any argument can be assigned the
.Dv NULL
value to indicate that it is not used as part of the matching criteria.
The
.Ar search_flag
controls the matching criteria:
.Bl -tag -width GET_AUTHPROF -offset Ds
.It Dv GET_ONE
The function returns the first match, setting the
.Fa next
pointer to
.Dv NULL .
.It Dv GET_ALL
The function returns all matching entries, using the
.Fa next
pointer to create a linked list of all entries that meet the search criteria.
.It Dv GET_PROF
Restrict the search to the unauthenticated profile list.
That is, profiles assigned via
.Dv PROFS_GRANTED
in
.Xr policy.conf 5
and via the
.Sy profiles
keyword in
.Xr user_attr 5 .
.It Dv GET_AUTHPROF
Restrict the search to the authenticated profile list.
That is, profiles assigned via
.Dv AUTHPROFS_GRANTED
in
.Xr policy.conf 5
and via the
.Sy auth_profiles
keyword in
.Xr user_attr 5 .
.El
.Pp
If both
.Dv GET_PROF
and
.Dv GET_AUTHPROF
are specified together, then both the authenticated and unauthenticated
profile lists are searched, in that order.
.Pp
Once a list of entries is returned by
.Fn getexecuser
or
.Fn getexecprof ,
the convenience function
.Fn match_execattr
can be used to identify an individual entry.
It returns a pointer to the individual element with the same profile name
.Pq Ar profname ,
type name
.Pq Ar type ,
and
.Ar id .
Function parameters set to
.Dv NULL
are not used as part of the matching criteria.
In the event that multiple entries meet the matching criteria, only a pointer
to the first entry is returned.
The
.Xr kva_match 3SECDB
function can be used to look up a key in a key-value array.
.Sh RETURN VALUES
Those functions returning data only return data related to the active policy.
The
.Fn getexecattr
function returns a pointer to a
.Vt execattr_t
if it successfully enumerates an entry; otherwise it returns
.Dv NULL ,
indicating the end of the enumeration.
.Sh USAGE
The
.Fn getexecattr ,
.Fn getexecuser , and
.Fn getexecprof
functions all allocate memory for the pointers they return.
This memory should be deallocated with the
.Fn free_execattr
call.
The
.Fn match_execattr
function does not allocate any memory.
Therefore, pointers returned by this function should not be deallocated.
.Pp
Individual attributes may be referenced in the
.Fa attr
structure by calling the
.Xr kva_match 3SECDB
function.
.Sh FILES
.Bl -tag -width Ds
.It Pa /etc/nsswitch.conf
configuration file lookup information for the name service switch
.It Pa /etc/user_attr
extended user attributes
.It Pa /etc/security/exec_attr
execution profiles
.It Pa /etc/security/policy.conf
policy definitions
.It Pa /etc/security/prof_attr
profile information
.El
.Sh EXAMPLES
.Sy Example 1 No Find all profiles that have the
.Xr ping 1
command.
.Bd -literal -offset 4n
 if ((execprof = getexecprof(NULL, KV_COMMAND, "/usr/sbin/ping",
     GET_ONE)) == NULL) {
	 /* do error */
 }
.Ed
.Pp
.Sy Example 2 No Find the entry for the
.Xr ping 1
command in the Network Administration Profile.
.Bd -literal -offset 4n
if ((execprof = getexecprof("Network Administration", KV_COMMAND,
    "/usr/sbin/ping", GET_ALL)) == NULL) {
	/* do error */
}
.Ed
.Pp
.Sy Example 3
Retrieve everything that can be done in the Filesystem Security profile.
.Bd -literal -offset 4n
if ((execprof = getexecprof("Filesystem Security", NULL, NULL,
    GET_ALL)) == NULL)) {
	/* do error */
}
.Ed
.Pp
.Sy Example 4 No Check if the
.Xr tar 1
utility is in an authenticated profile assigned to user
.Sq wetmore .
If there is no exact profile entry, the wildcard
.Pq \&* ,
if defined, is returned.
.Bd -literal -offset 4n
if ((execprof = getexecuser("wetmore", KV_COMMAND, "/usr/bin/tar",
    GET_ONE|GET_AUTHPROF)) == NULL) {
	 /* do error */
}
.Ed
.Sh MT-LEVEL
.Sy MT-Safe
.Sh SEE ALSO
.Xr getauthattr 3SECDB ,
.Xr getprofattr 3SECDB ,
.Xr getuserattr 3SECDB ,
.Xr kva_match 3SECDB ,
.Xr exec_attr 5 ,
.Xr passwd 5 ,
.Xr policy.conf 5 ,
.Xr prof_attr 5 ,
.Xr user_attr 5 ,
.Xr attributes 7
